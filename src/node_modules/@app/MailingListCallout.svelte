<script>
	import {isEmail} from '@app/email';
	import {scale} from 'svelte/transition';
	import WaitingAnimation from '@app/WaitingAnimation.svelte';

	// TODO animate while submitting

	let email = process.env.NODE_ENV === 'development' ? 'hi@test.com' : '';
	let submittedEmail;
	let inputEl;
	let buttonEl;
	let errorMessage;
	let submitting;

	const submit = async () => {
		if (!email) {
			inputEl.focus();
			errorMessage = 'Please enter an email address.';
			return;
		}
		if (!isEmail(email)) {
			inputEl.focus();
			errorMessage = 'Please enter a valid email address.';
			return;
		}

		buttonEl.focus();
		submitting = true;
		errorMessage = '';
		// await new Promise(r => setTimeout(r, 1000000));
		try {
			const res = await fetch('/mailing-list', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({email}),
			});
			if (res.ok) {
				submitting = false;
				submittedEmail = email;
				email = '';
				errorMessage = '';
			} else {
				submitting = false;
				errorMessage = `Something went wrong. Maybe check your Internet connection? Here's what the server said: "${res.statusText}"`;
			}
		} catch (err) {
			submitting = false;
			errorMessage = `Something went wrong. Is your Internet connection working? Please try again!`;
		}
	};

	const onKeyPress = e => {
		if (e.key === 'Enter') {
			submit();
		}
	};
</script>

<div class="wrapper">
	{#if !submittedEmail}
		<div transition:scale class="inner-wrapper">
			<h2>Want to learn more? Join our mailing list!</h2>
			<div class="input-wrapper">
				<input
					bind:this={inputEl}
					type="text"
					bind:value={email}
					on:keypress={onKeyPress}
					disabled={submitting}
					placeholder="email@address.com" />
				<button
					type="button"
					bind:this={buttonEl}
					on:click={submit}
					disabled={submitting}>
					{#if submitting}
						<WaitingAnimation />
					{:else}Send me updates!{/if}
				</button>
			</div>
			{#if errorMessage}
				<div>
					<p class="error">{errorMessage}</p>
				</div>
			{/if}
		</div>
	{:else}
		<div transition:scale class="inner-wrapper">
			<h2>Thank you for your interest!</h2>
			<p>
				We'll contact you at
				<span class="submitted-email">{submittedEmail}</span>
				when we're ready to share.
			</p>
		</div>
	{/if}
</div>

<style>
	.wrapper {
		height: 200px; /* hardcoded bc children are absolute pos for transiton */
		text-align: center;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		position: relative;
		margin-bottom: 1em;
	}
	.wrapper > div {
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
	}
	.inner-wrapper {
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.error {
		font-weight: bold;
		color: #495499;
	}
	.input-wrapper {
		display: flex;
		flex-direction: column;
		align-items: stretch;
		margin-bottom: 1em;
	}
	input {
		border-radius: 3px;
		border-width: 2px;
		border-color: rgb(84, 153, 73);
		padding: 10px 16px;
		text-align: center;
		margin-bottom: 10px;
	}
	input:focus {
		border-color: rgb(101, 185, 88);
		box-shadow: 0 4px 20px 1px rgba(84, 153, 73, 0.2),
			0 1px 5px 1px rgba(84, 153, 73, 0.4);
	}
	input[disabled] {
		background-color: rgba(208, 233, 203, 0.35);
	}
	button {
		border-radius: 3px;
		border-width: 2px;
		padding: 10px 16px;
		border-color: rgb(84, 153, 73);
		position: relative;
		background-color: rgba(84, 153, 73, 0.1);
		box-shadow: 0 -4px 20px 1px rgba(84, 153, 73, 0.1) inset,
			0 -2px 5px 1px rgba(84, 153, 73, 0.2) inset;
	}
	button:hover {
		background-color: rgba(84, 153, 73, 0.15);
		box-shadow: 0 -4px 20px 1px rgba(84, 153, 73, 0.2) inset,
			0 -2px 5px 1px rgba(84, 153, 73, 0.4) inset;
	}
	button:active {
		top: 1px;
		box-shadow: 0 4px 30px 1px rgba(84, 153, 73, 0.35) inset,
			0 2px 10px 1px rgba(84, 153, 73, 0.55) inset;
	}
	button[disabled] {
		top: 0;
		background-color: rgba(208, 233, 203, 0.35);
		box-shadow: 0 -4px 30px 1px rgba(223, 233, 221, 0.3) inset,
			0 -1px 10px 1px rgba(222, 230, 220, 0.5) inset;
	}
	p {
		margin: 0 0 0.5em;
	}
	.submitted-email {
		font-weight: bold;
		color: #495499;
	}
</style>
