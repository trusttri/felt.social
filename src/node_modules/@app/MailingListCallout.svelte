<script>
	import {isEmail} from '@app/email';
	import {scale} from 'svelte/transition';
	import WaitingAnimation from '@app/WaitingAnimation.svelte';
	import Button from '@app/Button.svelte';
	import Input from '@app/Input.svelte';

	// TODO animate while submitting

	let email = process.env.NODE_ENV === 'development' ? 'hi@test.com' : '';
	let submittedEmail;
	let inputEl;
	let buttonEl;
	let errorMessage;
	let submitting;

	const submit = async () => {
		if (!email) {
			inputEl.focus();
			errorMessage = 'please enter an email address :)';
			return;
		}
		if (!isEmail(email)) {
			inputEl.focus();
			errorMessage = 'please enter a valid email address :)';
			return;
		}

		buttonEl.focus();
		submitting = true;
		errorMessage = '';
		// await new Promise(r => setTimeout(r, 1000000));
		try {
			const res = await fetch('/mailing-list', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({email}),
			});
			if (res.ok) {
				submitting = false;
				submittedEmail = email;
				email = '';
				errorMessage = '';
			} else {
				submitting = false;
				errorMessage = `Something went wrong. Maybe check your Internet connection? Here's what the server said: "${res.statusText}"`;
			}
		} catch (err) {
			submitting = false;
			errorMessage = `Something went wrong. Is your Internet connection working? Please try again!`;
		}
	};

	const onKeyPress = e => {
		if (e.key === 'Enter') {
			submit();
		}
	};
</script>

<div class="wrapper">
	{#if !submittedEmail}
		<div transition:scale class="inner-wrapper">
			<h2>
				<div>want more?</div>
				<div>join our mailing list!</div>
			</h2>
			<div class="input-wrapper">
				<Input
					bind:el={inputEl}
					type="email"
					styles="margin-bottom: 10px; text-align: center;"
					bind:value={email}
					on:keypress={onKeyPress}
					disabled={submitting}
					placeholder="email@address.com" />
				<Button bind:el={buttonEl} on:click={submit} disabled={submitting}>
					{#if submitting}
						<WaitingAnimation />
					{:else}mail me updates!{/if}
				</Button>
			</div>
			{#if errorMessage}
				<div>
					<p class="error">{errorMessage}</p>
				</div>
			{/if}
		</div>
	{:else}
		<div transition:scale class="inner-wrapper">
			<h2>thanks for your interest!</h2>
			<p>
				we'll contact you at
				<span class="submitted-email">{submittedEmail}</span>
				when we're ready to share
			</p>
		</div>
	{/if}
</div>

<style>
	.wrapper {
		height: 250px; /* hardcoded bc children are absolute pos for transiton */
		min-width: 250px;
		text-align: center;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		position: relative;
	}
	.wrapper > div {
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
	}
	h2 {
		font-weight: 200;
	}
	.inner-wrapper {
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.error {
		font-weight: bold;
		color: rgb(73, 84, 153);
	}
	.input-wrapper {
		display: flex;
		flex-direction: column;
		align-items: stretch;
		margin-bottom: 1em;
	}
	p {
		margin: 0 0 0.5em;
	}
	.submitted-email {
		font-weight: bold;
		color: #495499;
	}
</style>
